name: Pi
on:
  push:
  pull_request:
  release:
    types: created

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Cargo Cache
        uses: Swatinem/rust-cache@v1

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install gcc-arm-linux-gnueabihf -y

      - name: Install Cargo Bundle
        run: cargo install cargo-bundle

      - name: Install ARM Rust Toolchain
        run: rustup target add armv7-unknown-linux-gnueabihf

      - name: Set ARM linker
        run: echo '[target.armv7-unknown-linux-gnueabihf]
          linker = "arm-linux-gnueabihf-gcc"' > ~/.cargo/config

      - name: Build
        run: cargo bundle --release --target=armv7-unknown-linux-gnueabihf

      - name: Upload binary
        uses: actions/upload-artifact@v2
        with:
          path: target/armv7-unknown-linux-gnueabihf/release/bundle/deb
          name: streamline-display_0.1.0_arm.deb

      - name: Get release
        if: ${{ github.event_name == 'release' }}
        id: get_release
        uses: bruceadams/get-release@v1.2.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Asset
        if: ${{ github.event_name == 'release' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.get_release.outputs.upload_url }}
          asset_path: target/armv7-unknown-linux-gnueabihf/release/bundle/deb/
          asset_name: streamline-display_0.1.0_arm.deb
          asset_content_type: application/octet-stream
